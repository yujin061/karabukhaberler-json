name: Karabuk Haberler JSON Güncelleme

on:
  schedule:
    - cron: '0 */4 * * *' # Her 4 saatte bir çalıştırılır
  workflow_dispatch: # Manuel tetikleme için

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Repository'i checkout yap
        uses: actions/checkout@v4

      - name: JSON verisini çek ve düzenle
        run: |
          curl -s https://services.karabuk.bel.tr/jsons-karabukbeltr/data/data-haberler.json | \
          sed 's/^var data = //' | \
          sed 's/;$//' | \
          jq '[.haberler[] | select(.haberkisa != "") | {
            kategoriadi: .kategoriadi,
            haberresim: .haberresim,
            haberbaslik: .haberbaslik,
            haberkisa: .haberkisa,
            tarih: .tarih,
            detay_url: (.haberdetay | gsub("<[^>]*>"; "") | gsub("&quot;"; "\"") | gsub("&Ccedil;"; "Ç") | gsub("&ccedil;"; "ç") | gsub("&Ouml;"; "Ö") | gsub("&ouml;"; "ö") | gsub("&Uuml;"; "Ü") | gsub("&uuml;"; "ü") | gsub("&rsquo;"; "’") | gsub("&nbsp;"; " ") | gsub("&ldquo;"; "“") | gsub("&rdquo;"; "”"))
          }]' > data-haberler.json

      - name: Değişiklikleri commit et
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add data-haberler.json
          git commit -m "JSON dosyası güncellendi"
          git push
