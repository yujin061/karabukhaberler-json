name: Update JSON File

on:
  schedule:
    - cron: '0 * * * *' # Her saat başı çalışır
  workflow_dispatch: # Manuel çalıştırma için

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install axios

      - name: Fetch and update JSON
        run: |
          node -e '
          const axios = require("axios");
          const fs = require("fs").promises;

          (async () => {
            try {
              console.log("JSON dosyası çekiliyor...");
              const response = await axios.get("https://services.karabuk.bel.tr/jsons-karabukbeltr/data/data-haberler.json", {
                headers: {
                  "User-Agent": "Mozilla/5.0",
                  "Accept": "application/json",
                },
                responseEncoding: "utf8",
                timeout: 10000
              });

              let jsonData = response.data;
              let jsonString = jsonData.toString();

              // BOM karakterini ve "var data =" kısmını temizle
              jsonString = jsonString.replace(/^\uFEFF/, "").replace("var data =", "").trim();

              // JSON’u parse et
              console.log("JSON parse ediliyor...");
              jsonData = JSON.parse(jsonString);

              // Haberler dizisini al ve formatla
              let newsList = [];
              let latestNewsId = 100667942; // Geçici olarak sabit ID

              if (jsonData && jsonData.haberler && Array.isArray(jsonData.haberler)) {
                newsList = jsonData.haberler.map((item, index) => {
                  const newsId = latestNewsId + (jsonData.haberler.length - 1) - index;
                  return {
                    haberbaslik: item.haberbaslik || "",
                    haberkisa: item.haberkisa || "",
                    tarih: item.tarih || "",
                    kategoriadi: item.kategoriadi || "",
                    haberresim: item.haberresim || "",
                    detay_url: "https://www.karabuk.bel.tr/haber.asp?id=" + newsId
                  };
                });
              } else {
                throw new Error("JSON formatı beklenenden farklı");
              }

              // Mevcut dosyayı güncelle
              const existingContent = await fs.readFile("data-haberler.json", "utf8").catch(() => "[]");
              const existingData = JSON.parse(existingContent);
              const isChanged = JSON.stringify(existingData) !== JSON.stringify(newsList);

              if (isChanged) {
                await fs.writeFile("data-haberler.json", JSON.stringify(newsList, null, 2));
                console.log("JSON dosyası güncellendi:", newsList.length, "haber");
              } else {
                console.log("Değişiklik yok.");
              }
            } catch (error) {
              console.error("Hata:", error.message);
              process.exit(1);
            }
          })();
          '

      - name: Commit changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add data-haberler.json
          git commit -m 'JSON dosyası güncellendi' || echo "Değişiklik yok"
          git push
