name: Karabuk Haberler JSON Güncelleme

on:
  schedule:
    - cron: '0 */4 * * *' # Her saat çalıştırılır
  workflow_dispatch: # Manuel tetikleme için

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Repository'i checkout yap
        uses: actions/checkout@v4

      - name: JSON verisini çek ve düzenle
        run: |
          curl -s https://services.karabuk.bel.tr/jsons-karabukbeltr/data/data-haberler.json | \
          sed 's/^var data = //' | \
          sed 's/;$//' | \
          jq '[.haberler[] | select(.haberkisa != "") | {
            kategoriadi: .kategoriadi,
            haberresim: .haberresim,
            haberbaslik: .haberbaslik,
            haberkisa: .haberkisa,
            tarih: .tarih,
            detay_url: (.haberdetay | gsub("<[^>]*>"; "") | gsub("&quot;"; "\"") | gsub("&Ccedil;"; "Ç") | gsub("&ccedil;"; "ç") | gsub("&Ouml;"; "Ö") | gsub("&ouml;"; "ö") | gsub("&Uuml;"; "Ü") | gsub("&uuml;"; "ü") | gsub("&rsquo;"; "’") | gsub("&nbsp;"; " ") | gsub("&ldquo;"; "“") | gsub("&rdquo;"; "”") | gsub("&ndash;"; "–") | gsub("&mdash;"; "—") | gsub("&amp;"; "&") | gsub("&lsquo;"; "‘") | gsub("&hellip;"; "…") | gsub("&aacute;"; "á") | gsub("&eacute;"; "é") | gsub("&iacute;"; "í") | gsub("&oacute;"; "ó") | gsub("&uacute;"; "ú") | gsub("&ntilde;"; "ñ") | gsub("&uuml;"; "ü") | gsub("&#39;"; "'") | gsub("&deg;"; "°") | gsub("\n"; "") | gsub("\t"; "") | gsub(" +"; " ") | trim)
          }]' > data-haberler.json

      - name: Değişiklikleri commit ve push et
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data-haberler.json
          git commit -m "🔄 data-haberler.json otomatik olarak güncellendi" || echo "Değişiklik yok"
          git push
