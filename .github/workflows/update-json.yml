- name: Fetch and update JSON
  run: |
    node -e "
    const axios = require('axios');
    const fs = require('fs').promises;

    (async () => {
      try {
        const response = await axios.get('https://services.karabuk.bel.tr/jsons-karabukbeltr/data/data-haberler.json', {
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
            'Accept': 'application/json, text/plain, */*',
            'Referer': 'https://www.karabuk.bel.tr/',
            'Accept-Language': 'tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7',
            'Connection': 'keep-alive'
          }
        });
        let jsonData = response.data;
        let jsonString = jsonData.toString();
        jsonString = jsonString.replace('var data =', '');
        jsonData = JSON.parse(jsonString);

        let newsList = [];
        if (Array.isArray(jsonData)) {
          let latestNewsId = 100667939;
          newsList = jsonData.map((item, index) => {
            const newsId = latestNewsId - index;
            return {
              haberbaslik: item.haberbaslik?.toString() ?? '',
              haberkisa: item.haberkisa?.toString() ?? '',
              tarih: item.tarih?.toString() ?? '',
              kategoriadi: item.kategoriadi?.toString() ?? '',
              okunma: item.okunma?.toString() ?? '',
              haberresim: item.haberresim?.toString() ?? '',
              detay_url: item.detay_url?.toString() || `https://www.karabuk.bel.tr/haber.asp?id=${newsId}`
            };
          });
        } else if (jsonData.haberler && Array.isArray(jsonData.haberler)) {
          let latestNewsId = 100667939;
          newsList = jsonData.haberler.map((item, index) => {
            const newsId = latestNewsId - index;
            return {
              haberbaslik: item.haberbaslik?.toString() ?? '',
              haberkisa: item.haberkisa?.toString() ?? '',
              tarih: item.tarih?.toString() ?? '',
              kategoriadi: item.kategoriadi?.toString() ?? '',
              okunma: item.okunma?.toString() ?? '',
              haberresim: item.haberresim?.toString() ?? '',
              detay_url: item.detay_url?.toString() || `https://www.karabuk.bel.tr/haber.asp?id=${newsId}`
            };
          });
        } else {
          throw new Error('JSON formatı beklenenden farklı');
        }

        await fs.writeFile('data-haberler.json', JSON.stringify(newsList, null, 2));
      } catch (error) {
        console.error('Hata:', error.message);
        process.exit(1);
      }
    })"
